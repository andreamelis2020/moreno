app.factory("RicercaService",["$http","$q","$sce","GeneralService",function(v,L,E,P){function x(b,a){var e=a.indexOf(b);if(-1<e){a.splice(e,1);for(var c in f)if(b==f[c].code)for(var d in f[c].children)a.splice(a.indexOf(f[c].children[d].code),1);for(c in g)if(b==g[c].code)for(d in g[c].children)a.splice(a.indexOf(g[c].children[d].code),1);for(c in h)if(b==h[c].code)for(d in h[c].children)a.splice(a.indexOf(h[c].children[d].code),1);for(c in k)if(b==k[c].code)for(d in k[c].children)a.splice(a.indexOf(k[c].children[d].code),
1)}else{a.push(b);for(c in f)if(b==f[c].code)for(d in f[c].children)a.push(f[c].children[d].code);for(c in g)if(b==g[c].code)for(d in g[c].children)a.push(g[c].children[d].code);for(c in h)if(b==h[c].code)for(d in h[c].children)a.push(h[c].children[d].code);for(c in k)if(b==k[c].code)for(d in k[c].children)a.push(k[c].children[d].code)}}function Q(){this.dataFine=this.dataInizio=null}function y(b,a,e){var c=L.defer();e?v({method:"GET",url:R+"/content.json?id="+b+"&modelId="+a,headers:{Authorization:"Bearer "+
e}}).then(function(a){c.resolve(a.data.response.result)},function(a){console.error(a);c.reject(a)}):v({method:"GET",url:R+"/content.json?id="+b+"&modelId="+a}).then(function(a){c.resolve(a.data.response.result)},function(a){console.error(a);c.reject(a)});return c.promise}function S(b){T=b-1;U()}function U(){angular.element("html, body").animate({scrollTop:$("#main_container").offset().top},800)}var F=P.getBaseURL()+"/api/plugins/advcontentsearch",R=P.getBaseURL()+"/legacyapi/rs/it/jacms";self=this;
var l=[],m=[],n=[],p=[],r=[],G="active",H="",I="",f=[],h=[],g=[],k=[];this.contentTypes="";this.activeChk;this.dataFine=this.dataInizio=null;var V=[],W=[];this.cercatxt;var M="",z="",t=[],N=[],T=0,A=[],J,u,K,q,w,B,C,D;var O=J=u=K=q=w=B=C=D="";return{Init:function(b){b.RicercaService=this},setArgomenti:function(b,a){"Argomenti"!=b&&V.push({name:b.replace("%","'"),code:a})},setCategorie:function(b,a,e,c){switch(e){case "amministrazione":if(c)for(var d in f)f[d].code==c&&f[d].children.push({name:b,code:a});
else f.push({name:b,code:a,children:[]});break;case "novita":if(c)for(d in g)g[d].code==c&&g[d].children.push({name:b,code:a});else g.push({name:b,code:a,children:[]});break;case "servizi":if(c)for(d in h)h[d].code==c&&h[d].children.push({name:b,code:a});else h.push({name:b,code:a,children:[]});break;case "documenti":if(c)for(d in k)k[d].code==c&&k[d].children.push({name:b,code:a});else k.push({name:b,code:a,children:[]})}},toggle:x,exists:function(b,a){return-1<a.indexOf(b)},ammins_isIndeterminate:function(){var b=
f.length,a;for(a in f)b+=f[a].children.length;return 0!==l.length&&l.length!==b},ammins_isChecked:function(){var b=f.length,a;for(a in f)b+=f[a].children.length;return l.length===b},ammins_toggleAll:function(){var b=f.length,a;for(a in f)b+=f[a].children.length;if(l.length===b)l=[];else if(0===l.length||0<l.length)for(a in l=[],f){l.push(f[a].code);for(var e in f[a].children)l.push(f[a].children[e].code)}},servizi_isIndeterminate:function(){var b=h.length,a;for(a in h)b+=h[a].children.length;return 0!==
m.length&&m.length!==b},servizi_isChecked:function(){var b=h.length,a;for(a in h)b+=h[a].children.length;return m.length===b},servizi_toggleAll:function(){var b=h.length,a;for(a in h)b+=h[a].children.length;if(m.length===b)m=[];else if(0===m.length||0<m.length)for(a in m=[],h){m.push(h[a].code);for(var e in h[a].children)m.push(h[a].children[e].code)}},novita_isIndeterminate:function(){var b=g.length,a;for(a in g)b+=g[a].children.length;return 0!==n.length&&n.length!==b},novita_isChecked:function(){var b=
g.length,a;for(a in g)b+=g[a].children.length;return n.length===b},novita_toggleAll:function(){var b=g.length,a;for(a in g)b+=g[a].children.length;if(n.length===b)n=[];else if(0===n.length||0<n.length)for(a in n=[],g){n.push(g[a].code);for(var e in g[a].children)n.push(g[a].children[e].code)}},docs_isIndeterminate:function(){var b=k.length,a;for(a in k)b+=k[a].children.length;return 0!==p.length&&p.length!==b},docs_isChecked:function(){var b=k.length,a;for(a in k)b+=k[a].children.length;return p.length===
b},docs_toggleAll:function(){var b=k.length,a;for(a in k)b+=k[a].children.length;if(p.length===b)p=[];else if(0===p.length||0<p.length)for(a in p=[],k){p.push(k[a].code);for(var e in k[a].children)p.push(k[a].children[e].code)}},toggleAll:function(b){"categorie"==b&&(l=[],m=[],n=[],p=[]);"argomenti"==b&&(r=[]);switch(b){case "categorie":l=[];m=[];n=[];p=[];break;case "argomenti":r=[];break;default:l=[],m=[],n=[],p=[],r=[],this.activeChk=!1,Q()}},class_tutti:function(b){switch(b){case "categorie":return 0!==
l.length||0!==m.length||0!==n.length||0!==p.length?"":"active";default:return 0!==l.length||0!==m.length||0!==n.length||0!==p.length||0!==r.length||0!=this.activeChk&&void 0!==this.activeChk||null!=this.dataInizio&&void 0!==this.dataInizio||null!=this.dataFine&&void 0!==this.dataFine?"":"active"}},class_categorie:function(b,a){return 0!==b.length&&b.length!==a.length?"active":b.length===a.length?"active":""},unchk:function(b,a){b=a.indexOf(b);-1<b&&a.splice(b,1)},clean_date:Q,setActive:function(b){switch(b){case "argomenti":G=
"";H="active";I="";break;case "opzioni":H=G="";I="active";break;default:G="active",I=H=""}},setContentTypes:function(b){this.contentTypes="";""!=b&&(this.contentTypes=b)},setUserToken:function(b){""!=b&&(this.userToken=b)},setArgsSelected:function(b){""!=b&&(r=b.split(","))},setCatSelected:function(b,a){if(""!=a)switch(b){case "amministrazione":l=a.split(",");break;case "servizi":m=a.split(",");break;case "novita":n=a.split(",");break;case "documenti":p=a.split(",")}},get_ammins_selected:function(){return l},
get_servizi_selected:function(){return m},get_novita_selected:function(){return n},get_docs_selected:function(){return p},get_args_selected:function(){return r},get_categoriaTab:function(){return G},get_argomentoTab:function(){return H},get_opzioniTab:function(){return I},get_ammins_chk:function(){return f},get_servizi_chk:function(){return h},get_novita_chk:function(){return g},get_docs_chk:function(){return k},getCercatxt:function(b){return this.cercatxt},setCercatxt:function(b){this.cercatxt=b},
get_dataInizio:function(){return this.dataInizio},set_dataInizio:function(b){this.dataInizio=b},get_dataFine:function(){return this.dataFine},set_dataFine:function(b){this.dataFine=b},get_argomenti:function(){return V},get_categorie:function(){return W},selectedRicercaTxtItemChanged:function(b){void 0!==b&&void 0!==b.contentName&&(this.cercatxt=b.contentName);void 0===b&&(this.cercatxt="")},chkCategoryCode:function(b){for(var a in f)b==f[a].code&&x(f[a].code,l);for(a in h)b==h[a].code&&x(h[a].code,
m);for(a in g)b==g[a].code&&x(g[a].code,n);for(a in k)b==k[a].code&&x(k[a].code,p)},getAutocompleteResults:function(b){var a="",e="",c=L.defer();u=this.contentTypes?"&filters[0].attribute=typeCode&filters[0].operator=eq&filters[0].allowedValues="+this.contentTypes:"";b&&(a="&filters[1].entityAttr=jacms:title&filters[1].operator=like&filters[1].value="+b);this.userToken?(e=this.userToken,v({method:"GET",url:encodeURI(F+"/contents.json?pageSize=9&text="+u+a),headers:{Authorization:"Bearer "+this.userToken}}).then(function(a){var b=
[],d;for(d in a.data.payload)y(a.data.payload[d],"list",e).then(function(a){var c={};c.icon=E.trustAsHtml($(a.html).find("svg").prop("innerHTML"));c.href=$(a.html).find("h4").find("a").prop("href");for(var d in a.item.attributes.attribute)a.item.attributes.attribute[d].roles&&(-1!=a.item.attributes.attribute[d].roles.role.indexOf("jacms:title")&&(c.contentName=a.item.attributes.attribute[d].value),-1!=a.item.attributes.attribute[d].roles.role.indexOf("jpattributeextended:sottosezione")&&(c.category=
a.item.attributes.attribute[d].value.value));b.unshift(c)},function(a){console.error("Errore durante il caricamento del contenuto")});b.push({searchButton:"hidden"});b.push({searchButton:!0});c.resolve(b)},function(a){console.error(a);c.reject(a)})):v({method:"GET",url:encodeURI(F+"/contents.json?pageSize=9&text="+u+a)}).then(function(a){var b=[],d;for(d in a.data.payload)y(a.data.payload[d],"list").then(function(a){var c={};c.icon=E.trustAsHtml($(a.html).find("svg").prop("innerHTML"));c.href=$(a.html).find("h4").find("a").prop("href");
for(var d in a.item.attributes.attribute)a.item.attributes.attribute[d].roles&&(-1!=a.item.attributes.attribute[d].roles.role.indexOf("jacms:title")&&(c.contentName=a.item.attributes.attribute[d].value),-1!=a.item.attributes.attribute[d].roles.role.indexOf("jpattributeextended:sottosezione")&&(c.category=a.item.attributes.attribute[d].value.value));b.unshift(c)},function(a){console.error("Errore durante il caricamento del contenuto")});b.push({searchButton:"hidden"});b.push({searchButton:!0});c.resolve(b)},
function(a){console.error(a);c.reject(a)});return c.promise},getContents:function(b){var a=0;void 0===b&&(b="1");J="&page="+b;S(b);this.contentTypes?(u="&filters["+a+"].attribute=typeCode&filters["+a+"].operator=eq&filters["+a+"].allowedValues="+this.contentTypes,a++):u="";void 0!==this.cercatxt&&""!==this.cercatxt&&(O="&text="+this.cercatxt+"*");void 0===this.orderBy&&(this.orderBy="data_pubb");switch(this.orderBy){case "data_pubb":w="&filters["+a+"].entityAttr=jpattributeextended:datapubblicazione&filters["+
a+"].order=DESC";a++;break;case "titolo_asc":w="&filters["+a+"].entityAttr=titolo&filters["+a+"].order=ASC";a++;break;case "titolo_desc":w="&filters["+a+"].entityAttr=titolo&filters["+a+"].order=DESC",a++}if(0<l.length||0<m.length||0<n.length||0<p.length){q="&filters["+a+"].entityAttr=jpattributeextended:sottosezione";b=0;for(var e in l)q+="&filters["+a+"].allowedValues["+b+"]="+l[e],b++;for(e in m)q+="&filters["+a+"].allowedValues["+b+"]="+m[e],b++;for(e in n)q+="&filters["+a+"].allowedValues["+
b+"]="+n[e],b++;for(e in p)q+="&filters["+a+"].allowedValues["+b+"]="+p[e],b++;a++}else q="";K=0<r.length?"&csvCategories[0]="+String(r):"";this.activeChk?(B="&filters["+a+"].entityAttr=jpattributeextended:dataScadenza&filters["+a+"].operator=gt&filters["+a+"].type=date&filters["+a+"].value="+(new Date).toISOString().slice(0,19).replace("T"," "),a++):B="";""!=this.dataInizio&&void 0!=this.dataInizio&&null!=this.dataInizio?(e=this.dataInizio.split("/"),C="&filters["+a+"].entityAttr=jpattributeextended:datapubblicazione&filters["+
a+"].operator=gt&filters["+a+"].type=date&filters["+a+"].value="+e[2]+"-"+e[1]+"-"+e[0]+" 00:00:00",a++):C="";""!=this.dataFine&&void 0!=this.dataFine&&null!=this.dataFine?(e=this.dataFine.split("/"),D="&filters["+a+"].entityAttr=jpattributeextended:datapubblicazione&filters["+a+"].operator=lt&filters["+a+"].type=date&filters["+a+"].value="+e[2]+"-"+e[1]+"-"+e[0]+" 23:59:59",a++):D="";var c=L.defer(),d="";this.userToken?(d=this.userToken,v({method:"GET",url:encodeURI(F+"/contents.json?pageSize=15"+
J+u+O+K+w+q+B+C+D),headers:{Authorization:"Bearer "+this.userToken}}).then(function(a){A=[];t=a.data.payload;M=String(a.data.metaData.totalItems);z=String(a.data.metaData.lastPage);for(a=0;a<z;a++)A[a]=a+1;for(a in t)y(t[a],"list",d).then(function(a){N[a.item.id]=E.trustAsHtml(a.html)},function(a){console.error("Errore durante il caricamento del contenuto")})},function(a){console.error(a);c.reject(a)})):v({method:"GET",url:encodeURI(F+"/contents.json?pageSize=15"+J+u+O+K+w+q+B+C+D)}).then(function(a){A=
[];t=a.data.payload;M=String(a.data.metaData.totalItems);z=String(a.data.metaData.lastPage);for(a=0;a<z;a++)A[a]=a+1;for(a in t)y(t[a],"list").then(function(a){N[a.item.id]=E.trustAsHtml(a.html)},function(a){console.error("Errore durante il caricamento del contenuto")})},function(a){console.error(a);c.reject(a)});return c.promise},getContent:y,getTotalItems:function(){return M},getNumberOfPages:function(){return z},getRenderContent:function(b){return N[b]},getContentsVar:function(b){return void 0!==
b?t[b]:t},getCurrentPage:function(){return T},getPages:function(){return A},goToPage:S,scrollTopPage:U,getAutocompleteIsOpened:function(){if(document.getElementById("cerca-txt")){if("true"==document.getElementById("cerca-txt").getAttribute("aria-expanded"))return!0;!1}}}}]);